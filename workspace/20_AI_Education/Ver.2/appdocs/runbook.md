# 運用手順書（Runbook）

- プロジェクト名: AIポリテラシー育成プログラム Ver.2
- 作成日: 2026-01-05
- 版: v1.0
- 関連文書: monitoring_spec.md, infrastructure_spec.md, operation_sop.md

---

## 1. 概要

### 1.1 目的

このRunbookは、AIポリテラシー育成プログラム Ver.2 の運用担当者向けに、日常運用タスク、障害対応手順、緊急連絡先をまとめたものです。

### 1.2 対象読者

- システム運用担当者
- 技術サポート担当者
- オンコール担当者

### 1.3 関連システム

| システム | URL | 用途 |
|---|---|---|
| 本番アプリ | https://ai-literacy.example.com | 受講者向けアプリ |
| Vercel Dashboard | https://vercel.com/team/ai-literacy | デプロイ・ログ |
| Supabase Dashboard | https://supabase.com/dashboard/project/xxxx | DB・認証 |
| Sentry | https://sentry.io/organizations/xxx | エラー監視 |
| UptimeRobot | https://uptimerobot.com/dashboard | 死活監視 |

---

## 2. 日次運用タスク

### 2.1 朝のチェック（9:00 JST）

| # | タスク | 確認方法 | 期待結果 |
|---|---|---|---|
| 1 | サービス稼働確認 | UptimeRobot確認 | 全モニターUP |
| 2 | エラー確認 | Sentry確認 | 新規Critical/Errorなし |
| 3 | デプロイ確認 | Vercel確認 | 前日デプロイ成功 |
| 4 | 評価処理確認 | 管理画面確認 | 評価エラーなし |

### 2.2 夕方のチェック（17:00 JST）

| # | タスク | 確認方法 | 期待結果 |
|---|---|---|---|
| 1 | 日次エラーサマリー | Sentry確認 | 重大エラーなし |
| 2 | パフォーマンス確認 | Vercel Analytics | LCP < 2.5s |
| 3 | 手動評価依頼確認 | 管理画面確認 | 未対応件数把握 |

### 2.3 チェック手順詳細

**UptimeRobotでの稼働確認**:
```
1. UptimeRobot (https://uptimerobot.com/dashboard) にログイン
2. 「AI-Literacy」グループを確認
3. すべてのモニターが「UP」であることを確認
4. 「DOWN」がある場合は「3.1 サービス停止」手順へ
```

**Sentryでのエラー確認**:
```
1. Sentry (https://sentry.io/organizations/xxx) にログイン
2. 「ai-literacy-prod」プロジェクトを選択
3. 「Issues」タブで未解決エラーを確認
4. Level: error 以上をフィルタ
5. 新規エラーがあれば調査開始
```

---

## 3. 障害対応手順

### 3.1 サービス停止（P1: Critical）

**症状**: アプリにアクセスできない、ログインできない

**初動対応（目標: 15分以内）**:

```
1. 影響範囲の確認
   - UptimeRobotでどのエンドポイントがDOWNか確認
   - 複数ユーザーで再現するか確認

2. Slackで障害宣言
   #alerts-ai-literacy チャンネルに投稿:
   「【障害発生】本番サービス停止 - 調査中」

3. Vercel状況確認
   - Vercel Dashboard → Deployments
   - 最新デプロイが失敗していないか確認
   - 失敗している場合 → 3.1.1 ロールバックへ

4. Supabase状況確認
   - Supabase Dashboard → Logs
   - DB接続エラーがないか確認
   - 接続エラーの場合 → 3.1.2 DB障害対応へ
```

#### 3.1.1 Vercelロールバック

```bash
# 方法1: Vercel Dashboard
1. Vercel Dashboard → Deployments
2. 前回成功したデプロイを選択
3. 「...」→「Promote to Production」

# 方法2: CLI
vercel rollback --yes
```

#### 3.1.2 DB障害対応

```
1. Supabase Dashboard → Database → Connection Pooling
2. 接続数を確認（上限に達していないか）
3. 必要に応じてConnection Poolerを再起動

4. それでも復旧しない場合:
   - Supabaseサポートに連絡
   - support@supabase.io
```

### 3.2 評価処理エラー（P2: High）

**症状**: 課題提出後、評価が完了しない

**初動対応（目標: 30分以内）**:

```
1. エラー状況の確認
   - 管理画面 → 評価管理 → エラー一覧
   - エラーメッセージを確認

2. エラー種別による対応

   [APIエラー] Gemini API障害
   → Google Cloud Status確認
   → 復旧まで手動評価に切り替え

   [レート制限] 429 Too Many Requests
   → 一時的に待機
   → 30分後に再評価実行

   [コンテンツフィルター] 提出内容がフィルタに該当
   → 手動評価に切り替え
   → 受講者にフィードバック

3. 手動評価への切り替え
   - 管理画面で「手動評価に切り替え」を実行
   - 講師に手動評価を依頼
```

### 3.3 ログイン障害（P2: High）

**症状**: ユーザーがログインできない

**初動対応**:

```
1. 影響範囲の確認
   - 特定ユーザーのみ → 個別対応
   - 全ユーザー → 認証基盤障害

2. Supabase Auth確認
   - Supabase Dashboard → Auth → Users
   - ログイン試行ログを確認

3. 個別ユーザーの場合
   - パスワードリセットを実施
   - アカウントロック状態を確認

4. 全ユーザーの場合
   - Supabase Status確認
   - 復旧を待つ or サポートに連絡
```

### 3.4 パフォーマンス低下（P3: Medium）

**症状**: レスポンスが遅い、タイムアウトが発生

**初動対応（目標: 1時間以内）**:

```
1. Vercel Analytics確認
   - どのページ/APIが遅いか特定
   - LCP、TTFBの値を確認

2. Vercel Logsで詳細調査
   - 該当エンドポイントのログを確認
   - 実行時間が長いクエリを特定

3. 対処
   - DBクエリ最適化が必要 → 開発チームにエスカレーション
   - 一時的な負荷 → 様子見

4. キャッシュクリア（必要な場合）
   - Vercel Dashboard → Settings → Advanced
   - 「Purge Cache」を実行
```

### 3.5 メール送信障害（P3: Medium）

**症状**: 通知メールが届かない

**初動対応**:

```
1. Resend Dashboard確認
   - https://resend.com/dashboard
   - 送信ログでエラーを確認

2. エラー種別による対応

   [バウンス] メールアドレスが無効
   → 受講者にメールアドレス確認を依頼

   [レート制限] 送信上限に達した
   → プラン確認、必要に応じてアップグレード

   [ドメイン認証エラー] SPF/DKIM設定問題
   → DNS設定を確認

3. 代替手段
   - 重要な通知は手動でメール送信
   - Slackでの連絡に切り替え
```

---

## 4. エスカレーションフロー

### 4.1 エスカレーション基準

| 重要度 | 条件 | エスカレーション先 | 対応時間 |
|---|---|---|---|
| P1 | サービス全停止 | 開発責任者 → 講師 | 即時 |
| P2 | 主要機能障害 | 開発責任者 | 1時間以内 |
| P3 | 一部機能障害 | 担当者間で対応 | 24時間以内 |
| P4 | 軽微な問題 | 次営業日対応 | 1週間以内 |

### 4.2 連絡先

| 役割 | 名前 | 連絡先 | 対応時間 |
|---|---|---|---|
| 開発責任者 | [氏名] | [電話/Slack] | 9:00-21:00 |
| 講師 | 井戸 | [電話/Slack] | 緊急時のみ |
| Supabaseサポート | - | support@supabase.io | 24時間 |
| Vercelサポート | - | support@vercel.com | 24時間 |

### 4.3 エスカレーション連絡テンプレート

```
【障害報告】{重要度}: {障害概要}

■ 発生日時: YYYY-MM-DD HH:MM

■ 影響範囲:
- 影響ユーザー数: 約XX名
- 影響機能: ログイン / 課題提出 / 評価 など

■ 症状:
{具体的な症状}

■ 原因（判明している場合）:
{原因}

■ 対応状況:
{実施した対応}

■ 次のアクション:
{予定している対応}

■ 復旧見込み:
{見込み時刻 or 不明}
```

---

## 5. 週次運用タスク

### 5.1 月曜日

| # | タスク | 担当 |
|---|---|---|
| 1 | 週次エラーレビュー | 運用担当 |
| 2 | パフォーマンストレンド確認 | 運用担当 |
| 3 | 進捗遅れ受講者の確認 | 講師/サポート |

### 5.2 金曜日

| # | タスク | 担当 |
|---|---|---|
| 1 | リマインドメール送信確認 | 運用担当 |
| 2 | 週次バックアップ確認 | 運用担当 |
| 3 | 翌週のミーティング準備確認 | 講師 |

### 5.3 週次レビュー手順

```
1. Sentryで週間エラートレンドを確認
   - Issues → Last 7 Days
   - 繰り返し発生しているエラーを特定
   - 対応優先度を決定

2. Vercel Analyticsでパフォーマンス確認
   - Core Web Vitalsの推移
   - 目標値を下回っている場合は調査

3. 管理画面で利用状況確認
   - アクティブユーザー数
   - 課題提出数
   - 評価処理数
```

---

## 6. 月次運用タスク

### 6.1 月次チェックリスト

| # | タスク | 確認ポイント |
|---|---|---|
| 1 | SLA達成状況確認 | 可用性99.5%達成か |
| 2 | コスト確認 | Vercel/Supabase/Gemini API |
| 3 | セキュリティ更新 | 依存パッケージの更新 |
| 4 | バックアップ復元テスト | 年1回以上実施 |
| 5 | 監査ログレビュー | 異常なアクセスパターンがないか |

### 6.2 コスト確認手順

```
1. Vercel請求確認
   - Vercel Dashboard → Settings → Billing
   - 月間使用量を確認

2. Supabase請求確認
   - Supabase Dashboard → Settings → Billing
   - 月間使用量を確認

3. Gemini API使用量確認
   - Google Cloud Console → API & Services
   - Generative Language API の使用量を確認
```

---

## 7. 緊急連絡先一覧

### 7.1 内部連絡先

| 役割 | 連絡先 | 対応時間 |
|---|---|---|
| 運用担当 | #ops-ai-literacy (Slack) | 営業時間 |
| 開発チーム | #dev-ai-literacy (Slack) | 営業時間 |
| オンコール | [PagerDuty等] | 24時間 |

### 7.2 外部連絡先

| サービス | 連絡先 | 対応時間 |
|---|---|---|
| Vercel | support@vercel.com | 24時間 |
| Supabase | support@supabase.io | 24時間 |
| Resend | support@resend.com | 営業時間 |
| Google Cloud | コンソールからチケット作成 | 24時間 |

---

## 8. 定期メンテナンス

### 8.1 メンテナンス実施時間

- **推奨時間帯**: 平日 3:00-5:00 JST（利用者最少時間帯）
- **事前告知**: 48時間前までにユーザーへ通知

### 8.2 メンテナンス手順

```
1. 事前準備（D-2）
   - 変更内容の最終確認
   - ロールバック計画の確認
   - メンテナンス告知メール送信

2. メンテナンス開始
   - メンテナンスモード有効化
   - メンテナンスページ表示確認

3. 作業実施
   - 計画された作業を実施
   - 各ステップで動作確認

4. 復旧確認
   - 全機能の動作確認
   - メンテナンスモード解除

5. 完了報告
   - Slackで完了報告
   - 必要に応じてユーザーへメール
```

### 8.3 メンテナンスモードの有効化

```typescript
// Vercel環境変数で制御
MAINTENANCE_MODE=true

// middleware.tsで判定
if (process.env.MAINTENANCE_MODE === 'true') {
  return NextResponse.rewrite(new URL('/maintenance', request.url));
}
```

---

## 9. 障害報告書テンプレート

### 9.1 障害報告書（ポストモーテム）

```markdown
# 障害報告書

## 基本情報
- 障害ID: INC-YYYY-MM-DD-001
- 発生日時: YYYY-MM-DD HH:MM ～ HH:MM
- 復旧日時: YYYY-MM-DD HH:MM
- 影響時間: X時間Y分
- 重要度: P1/P2/P3/P4

## 影響範囲
- 影響ユーザー数: XX名
- 影響機能: [機能名]
- ビジネスインパクト: [影響内容]

## タイムライン
| 時刻 | イベント |
|---|---|
| HH:MM | [イベント内容] |
| HH:MM | [イベント内容] |

## 根本原因
[原因の詳細]

## 対応内容
[実施した対応]

## 再発防止策
| # | 対策 | 担当 | 期限 |
|---|---|---|---|
| 1 | [対策内容] | [担当者] | [期限] |

## 教訓
[今後に活かすべき学び]
```

---

## 10. 変更履歴

| 日付 | バージョン | 変更内容 |
|---|---|---|
| 2026-01-05 | v1.0 | 初版作成 |
